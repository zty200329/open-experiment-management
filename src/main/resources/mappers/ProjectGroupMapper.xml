<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.swpu.uchain.openexperiment.mapper.ProjectGroupMapper">
    <resultMap id="OpenTopicInfoResultMap" type="com.swpu.uchain.openexperiment.VO.project.OpenTopicInfo">
        <id column="id" jdbcType="BIGINT" property="id" />
        <result column="subordinate_college" property="subordinateCollege"/>
        <result column="serial_number" jdbcType="VARCHAR" property="serialNumber"/>
        <result column="address" jdbcType="VARCHAR" property="address" />
        <result column="end_time" jdbcType="TIMESTAMP" property="endTime" />
        <result column="experiment_condition" jdbcType="VARCHAR" property="experimentCondition" />
        <result column="suggest_group_type" jdbcType="INTEGER" property="suggestGroupType" />
        <result column="experiment_type" jdbcType="INTEGER" property="experimentType" />
        <result column="achievement_check" jdbcType="VARCHAR" property="achievementCheck" />
        <result column="limit_college" jdbcType="VARCHAR" property="limitCollege" />
        <result column="limit_major" jdbcType="VARCHAR" property="limitMajor" />
        <result column="limit_grade" jdbcType="INTEGER" property="limitGrade" />
        <result column="fit_people_num" jdbcType="INTEGER" property="fitPeopleNum" />
        <result column="total_hours" jdbcType="INTEGER" property="totalHours" />
        <result column="lab_name" jdbcType="VARCHAR" property="labName" />
        <result column="project_name" jdbcType="VARCHAR" property="projectName" />
        <result column="project_type" jdbcType="INTEGER" property="projectType" />
        <result column="start_time" jdbcType="TIMESTAMP" property="startTime" />
        <result column="main_content" jdbcType="LONGVARCHAR" property="mainContent"/>
        <result column="amount_of_selected" property="amountOfSelected"/>
        <collection property="teachers" ofType="com.swpu.uchain.openexperiment.VO.user.Instructor"
                  javaType="java.util.ArrayList" columnPrefix="t_">
          <id column="real_name" property="realName"/>
          <id column="qq_num" property="qqNum"/>
          <id column="mobile_phone" property="mobilePhone"/>
          <id column="email" property="email"/>
          <id column="fix_phone" property="fixPhone"/>
          <id column="sex" property="sex"/>
          <result column="user_id" property="userId"/>
        </collection>
    </resultMap>

    <resultMap id="ProjectGroupDetailVOResultMap" type="com.swpu.uchain.openexperiment.VO.project.ProjectGroupDetailVO">
        <id column="id" jdbcType="BIGINT" property="id" />
        <result column="address" jdbcType="VARCHAR" property="address" />
        <result column="subordinate_college" property="subordinateCollege"/>
        <result column="serial_number" jdbcType="VARCHAR" property="serialNumber"/>
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
        <result column="creator_id" jdbcType="BIGINT" property="creatorId" />
        <result column="end_time" jdbcType="TIMESTAMP" property="endTime" />
        <result column="experiment_condition" jdbcType="VARCHAR" property="experimentCondition" />
        <result column="suggest_group_type" jdbcType="INTEGER" property="suggestGroupType" />
        <result column="experiment_type" jdbcType="INTEGER" property="experimentType" />
        <result column="achievement_check" jdbcType="VARCHAR" property="achievementCheck" />
        <result column="limit_college" jdbcType="VARCHAR" property="limitCollege" />
        <result column="limit_major" jdbcType="VARCHAR" property="limitMajor" />
        <result column="limit_grade" jdbcType="INTEGER" property="limitGrade" />
        <result column="fit_people_num" jdbcType="INTEGER" property="fitPeopleNum" />
        <result column="total_hours" jdbcType="INTEGER" property="totalHours" />
        <result column="lab_name" jdbcType="VARCHAR" property="labName" />
        <result column="project_name" jdbcType="VARCHAR" property="projectName" />
        <result column="project_type" jdbcType="INTEGER" property="projectType" />
        <result column="start_time" jdbcType="TIMESTAMP" property="startTime" />
        <result column="status" jdbcType="INTEGER" property="status" />
        <result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
        <result column="main_content" jdbcType="LONGVARCHAR" property="mainContent"/>
        <result column="is_open_topic" jdbcType="INTEGER" property="isOpenTopic"/>
        <result column="apply_funds" property="applyFunds"/>
        <result column="whether_commit_key_apply" property="whetherCommitKeyApply"/>
        <result column="key_project_status" property="keyProjectStatus"/>
        <collection property="list" ofType="com.swpu.uchain.openexperiment.VO.user.ProjectUserVO"
                    javaType="java.util.ArrayList" columnPrefix="u_">
            <id column="real_name" property="realName"/>
            <id column="qq_num" property="qqNum"/>
            <id column="mobile_phone" property="mobilePhone"/>
            <id column="email" property="email"/>
            <id column="fix_phone" property="fixPhone"/>

            <id column="sex" property="sex"/>
            <id column="institute" property="institute"/>
            <id column="major" property="major"/>
            <id column="user_type" property="userType"/>
            <id column="code" property="code"/>

            <id column="technical_role" property="technicalRole"/>
            <id column="work_division" property="workDivision"/>
            <id column="join_time" property="joinTime"/>
            <id column="personal_judge" property="personalJudge"/>
            <id column="member_role" property="memberRole"/>
            <id column="grade" property="grade"/>
        </collection>
    </resultMap>


    <resultMap id="ProjectGroupResultMap" type="com.swpu.uchain.openexperiment.domain.ProjectGroup">
        <id column="id" jdbcType="BIGINT" property="id" />
        <result column="serial_number" jdbcType="VARCHAR" property="serialNumber"/>
        <result column="subordinate_college" property="subordinateCollege"/>
        <result column="address" jdbcType="VARCHAR" property="address" />
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
        <result column="creator_id" jdbcType="BIGINT" property="creatorId" />
        <result column="end_time" jdbcType="TIMESTAMP" property="endTime" />
        <result column="experiment_condition" jdbcType="VARCHAR" property="experimentCondition" />
        <result column="suggest_group_type" jdbcType="INTEGER" property="suggestGroupType" />
        <result column="experiment_type" jdbcType="INTEGER" property="experimentType" />
        <result column="achievement_check" jdbcType="VARCHAR" property="achievementCheck" />
        <result column="limit_college" jdbcType="VARCHAR" property="limitCollege" />
        <result column="limit_major" jdbcType="VARCHAR" property="limitMajor" />
        <result column="limit_grade" jdbcType="INTEGER" property="limitGrade" />
        <result column="fit_people_num" jdbcType="INTEGER" property="fitPeopleNum" />
        <result column="total_hours" jdbcType="INTEGER" property="totalHours" />
        <result column="lab_name" jdbcType="VARCHAR" property="labName" />
        <result column="project_name" jdbcType="VARCHAR" property="projectName" />
        <result column="project_type" jdbcType="INTEGER" property="projectType" />
        <result column="start_time" jdbcType="TIMESTAMP" property="startTime" />
        <result column="status" jdbcType="INTEGER" property="status" />
        <result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
        <result column="main_content" jdbcType="LONGVARCHAR" property="mainContent"/>
        <result column="apply_funds" property="applyFunds"/>
        <result column="is_open_topic" jdbcType="INTEGER" property="isOpenTopic"/>
        <result column="key_project_status" property="keyProjectStatus"/>
    </resultMap>

    <resultMap id="ProjectTableInfoResultMap" type="com.swpu.uchain.openexperiment.VO.project.ProjectTableInfo">

        <id column="id" jdbcType="BIGINT" property="id" />
        <result column="serial_number" jdbcType="VARCHAR" property="serialNumber"/>
        <result column="address" jdbcType="VARCHAR" property="address" />
        <result column="end_time" jdbcType="TIMESTAMP" property="endTime" />
        <result column="suggest_group_type" jdbcType="INTEGER" property="suggestGroupType" />
        <result column="experiment_type" jdbcType="INTEGER" property="experimentType" />
        <result column="total_hours" jdbcType="INTEGER" property="totalHours" />
        <result column="temp_serial_number" property="tempSerialNumber"/>
        <result column="lab_name" jdbcType="VARCHAR" property="labName" />
        <result column="project_name" jdbcType="VARCHAR" property="projectName" />
        <result column="start_time" jdbcType="TIMESTAMP" property="startTime" />
        <result column="apply_funds" property="applyFunds"/>
        <result column="project_type" property="projectType"/>

    </resultMap>

    <resultMap id="CheckProjectResultMap" type="com.swpu.uchain.openexperiment.VO.project.CheckProjectVO">
        <id column="id" jdbcType="BIGINT" property="id" />
        <result column="apply_funds" property="applyFunds"/>
        <result column="address" jdbcType="VARCHAR" property="address" />
        <result column="is_open_topic" property="isOpenTopic"/>
        <result column="serial_number" jdbcType="VARCHAR" property="serialNumber"/>
        <result column="limit_college" jdbcType="VARCHAR" property="limitCollege" />
        <result column="project_name" jdbcType="VARCHAR" property="projectName" />
        <result column="project_type" jdbcType="INTEGER" property="projectType" />
        <result column="start_time" jdbcType="TIMESTAMP" property="startTime" />
        <result column="end_time" jdbcType="TIMESTAMP" property="endTime" />
        <result column="total_hours" jdbcType="INTEGER" property="totalHours" />
        <result column="lab_name" jdbcType="VARCHAR" property="labName" />
        <result column="experiment_type" jdbcType="INTEGER" property="experimentType" />
        <result column="suggest_group_type" jdbcType="INTEGER" property="suggestGroupType" />
        <result column="subordinate_college" property="subordinateCollege"/>
        <result column="apply_funds" property="applyFunds"/>
    </resultMap>

    <resultMap id="SelectProjectMap" type="com.swpu.uchain.openexperiment.VO.project.SelectProjectVO">
    <id column="id" jdbcType="BIGINT" property="projectGroupId" />
    <result column="project_name" jdbcType="VARCHAR" property="projectName" />
    <result column="real_name" jdbcType="VARCHAR" property="creatorName"/>
    </resultMap>


  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
    delete from openexperiment.project_group
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" useGeneratedKeys="true" keyProperty="id" parameterType="com.swpu.uchain.openexperiment.domain.ProjectGroup">
      insert into openexperiment.project_group (id, address, create_time,
                                 creator_id, end_time, experiment_condition,
                                 suggest_group_type, experiment_type, achievement_check,
                                 limit_college, limit_major, limit_grade,
                                 fit_people_num, total_hours, lab_name,
                                 project_name, project_type, start_time,
                                 `status`, update_time, apply_funds, is_open_topic
                                 , main_Content,subordinate_college,serial_number)
      values (
                 #{id,jdbcType=BIGINT}, #{address,jdbcType=VARCHAR}, #{createTime,jdbcType=TIMESTAMP},
                 #{creatorId,jdbcType=BIGINT}, #{endTime,jdbcType=TIMESTAMP}, #{experimentCondition,jdbcType=VARCHAR},
                 #{suggestGroupType,jdbcType=INTEGER}, #{experimentType,jdbcType=INTEGER}, #{achievementCheck,jdbcType=VARCHAR},
                 #{limitCollege,jdbcType=VARCHAR}, #{limitMajor,jdbcType=VARCHAR}, #{limitGrade,jdbcType=INTEGER},
                 #{fitPeopleNum,jdbcType=INTEGER}, #{totalHours,jdbcType=INTEGER}, #{labName,jdbcType=VARCHAR},
                 #{projectName,jdbcType=VARCHAR}, #{projectType,jdbcType=INTEGER}, #{startTime,jdbcType=TIMESTAMP},
                 #{status,jdbcType=INTEGER}, #{updateTime,jdbcType=TIMESTAMP},#{applyFunds,jdbcType=FLOAT},
                 #{isOpenTopic},#{mainContent},#{subordinateCollege},#{serialNumber})
  </insert>
  <update id="updateByPrimaryKey" parameterType="com.swpu.uchain.openexperiment.domain.ProjectGroup">
    update openexperiment.project_group
    set address = #{address,jdbcType=VARCHAR},
      create_time = #{createTime,jdbcType=TIMESTAMP},
      end_time = #{endTime,jdbcType=TIMESTAMP},
      experiment_condition = #{experimentCondition,jdbcType=VARCHAR},
      suggest_group_type = #{suggestGroupType,jdbcType=INTEGER},
      apply_funds = #{applyFunds},
      experiment_type = #{experimentType,jdbcType=INTEGER},
      achievement_check = #{achievementCheck,jdbcType=VARCHAR},
      limit_college = #{limitCollege,jdbcType=VARCHAR},
      limit_major = #{limitMajor,jdbcType=VARCHAR},
      limit_grade = #{limitGrade,jdbcType=INTEGER},
      fit_people_num = #{fitPeopleNum,jdbcType=INTEGER},
      total_hours = #{totalHours,jdbcType=INTEGER},
      lab_name = #{labName,jdbcType=VARCHAR},
      project_name = #{projectName,jdbcType=VARCHAR},
      project_type = #{projectType,jdbcType=INTEGER},
      start_time = #{startTime,jdbcType=TIMESTAMP},
      `status` = #{status,jdbcType=INTEGER},
      update_time = #{updateTime,jdbcType=TIMESTAMP},
      main_content = #{mainContent}
    where id = #{id,jdbcType=BIGINT}
  </update>
    <update id="updateProjectStatusOfList">
        update openexperiment.project_group set `status` = #{status} where id in
        <foreach collection="list" item="id" separator="," open="(" close=")">
            #{id}
        </foreach>
    </update>

    <select id="selectByPrimaryProjectName" resultType="com.swpu.uchain.openexperiment.domain.ProjectGroup">
        select id,
               address,
               create_time,
               creator_id,
               end_time,
               experiment_condition,
               suggest_group_type,
               experiment_type,
               achievement_check,
               limit_college,
               limit_major,
               limit_grade,
               fit_people_num,
               total_hours,
               lab_name,
               project_name,
               project_type,
               start_time,
               `status`,
               update_time,
               main_Content
        from openexperiment.project_group
        where project_name = #{projectName,jdbcType=VARCHAR}
    </select>


    <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="ProjectGroupResultMap">
    select id,
           address,
           serial_number,
           project_group.create_time,
           project_group.creator_id,
           end_time,
           experiment_condition,
           suggest_group_type,
           experiment_type,
           achievement_check,
           limit_college,
           limit_major,
           limit_grade,
           fit_people_num,
           total_hours,
           lab_name,
           project_name,
           project_type,
           start_time,
           is_open_topic,
           project_group.`status`,
           key_project_status.project_id as whetherCommitKeyApply,
           key_project_status.status as key_project_status,
           update_time,
           main_Content,
           apply_funds
    from openexperiment.project_group left join openexperiment.key_project_status  on key_project_status.project_id = project_group.id
    where project_group.id = #{id,jdbcType=BIGINT}
  </select>
  <select id="selectByName" resultMap="ProjectGroupResultMap">
    select id, serial_number, status, project_type, creator_id, end_time, apply_funds, lab_name, experiment_type, achievement_check, limit_college, limit_major, limit_grade, fit_people_num, total_hours, experiment_condition, project_name, create_time, start_time, address, suggest_group_type, update_time, is_open_topic, main_Content, subordinate_college from openexperiment.project_group where project_name = #{projectName}
  </select>
  <select id="selectByUserIdAndStatus" resultMap="ProjectGroupResultMap">
    select
          openexperiment.user_project_group.project_group_id as id,
          openexperiment.project_group.address,
          openexperiment.project_group.serial_number,
          openexperiment.project_group.create_time,
          openexperiment.project_group.creator_id,
          openexperiment.project_group.end_time,
          openexperiment.project_group.experiment_condition,
          openexperiment.project_group.suggest_group_type,
          openexperiment.project_group.experiment_type,
          openexperiment.project_group.achievement_check,
          openexperiment.project_group.limit_college,
          openexperiment.project_group.limit_major,
          openexperiment.project_group.limit_grade,
          openexperiment.project_group.fit_people_num,
          openexperiment.project_group.total_hours,
          openexperiment.project_group.lab_name,
          openexperiment.project_group.project_name,
          openexperiment.project_group.project_type,
          openexperiment.project_group.start_time,
          openexperiment.project_group.`status`,
          openexperiment.project_group.update_time,
          openexperiment.project_group.main_Content,
          openexperiment.project_group.is_open_topic
    from openexperiment.project_group inner join openexperiment.user_project_group on user_project_group.project_group_id = openexperiment.project_group.id
            <if test="status!=null">
                and user_project_group.`status` = #{status}
            </if>
    <where>
    <if test="userId!=null">
        user_project_group.user_id = #{userId}
    </if>
    <if test="projectStatus!=null">
        and openexperiment.project_group.`status` = #{projectStatus}
    </if>
    </where>
  </select>
    <select id="selectFunctionCreateCommonApply" resultMap="CheckProjectResultMap">
        select openexperiment.project_group.limit_college,
           openexperiment.project_group.is_open_topic,
           openexperiment.project_group.serial_number,
           openexperiment.project_group.id,
           openexperiment.project_group.apply_funds,
           openexperiment.project_group.project_name,
           openexperiment.project_group.experiment_type,
           openexperiment.project_group.total_hours,
           openexperiment.project_group.start_time,
           openexperiment.project_group.end_time,
           openexperiment.project_group.lab_name,
           openexperiment.project_group.address,
           openexperiment.project_group.subordinate_college,
           openexperiment.project_group.suggest_group_type,
           openexperiment.project_group.project_type,
           openexperiment.project_group.main_Content,
           openexperiment.project_group.apply_funds
    from openexperiment.project_group
        where openexperiment.project_group.subordinate_college = 0;
    </select>
    
    
  <select id="selectApplyOrderByTime" resultMap="CheckProjectResultMap">
    select openexperiment.project_group.limit_college,
           openexperiment.project_group.is_open_topic,
           openexperiment.project_group.serial_number,
           openexperiment.project_group.id,
           openexperiment.project_group.apply_funds,
           openexperiment.project_group.project_name,
           openexperiment.project_group.experiment_type,
           openexperiment.project_group.total_hours,
           openexperiment.project_group.start_time,
           openexperiment.project_group.end_time,
           openexperiment.project_group.lab_name,
           openexperiment.project_group.address,
           openexperiment.project_group.subordinate_college,
           openexperiment.project_group.suggest_group_type,
           openexperiment.project_group.project_type,
           openexperiment.project_group.main_Content,
           openexperiment.project_group.apply_funds
    from openexperiment.project_group
    where status = #{projectStatus}
    <if test="projectType!=null">
        and project_type = #{projectType}
    </if>
    <if  test="college!=0">
        and subordinate_college = #{college}
    </if>
    order by create_time desc
  </select>
  <select id="selectByFuzzyName" resultMap="SelectProjectMap">
    select openexperiment.project_group.id, openexperiment.project_group.project_name, u_stu.real_name
    from openexperiment.project_group
           inner join openexperiment.u_stu on project_group.creator_id = u_stu.id
    where project_group.project_name like '%${name}%'
  </select>
    <select id="getAllOpenTopic" resultMap="OpenTopicInfoResultMap">
      select project_group.id,
             project_group.subordinate_college,
             project_group.serial_number,
             project_group.address,
             project_group.create_time,
             project_group.creator_id,
             project_group.end_time,
             project_group.experiment_condition,
             project_group.suggest_group_type,
             project_group.experiment_type,
             project_group.achievement_check,
             project_group.limit_college,
             project_group.limit_major,
             project_group.limit_grade,
             project_group.fit_people_num,
             project_group.total_hours,
             project_group.lab_name,
             project_group.project_name,
             project_group.project_type,
             project_group.start_time,
             project_group.`status`,
             project_group.update_time,
             project_group.main_Content,
             user_project_group.user_id,
             u_stu.fix_phone as t_fix_phone,
             u_stu.mobile_phone as t_mobile_phone,
             u_stu.qq_num as t_qq_num,
             u_stu.sex as t_sex,
             u_stu.email as t_email,
             u_stu.real_name as t_real_name,
             u_stu.code as t_user_id
      from openexperiment.project_group
             inner join openexperiment.user_project_group on openexperiment.project_group.id = user_project_group.project_group_id <!--and user_project_group.status = 2-->
             inner join openexperiment.u_stu on user_project_group.user_id = u_stu.code
        where project_group.status = 1<!--1指的是实验室审核通过-->  and project_group.is_open_topic !=2 and member_role = 1<!--2是指不开放-->
        <if test="list!=null">
            and project_group.id in
            <foreach collection="list" item="id" separator="," open="(" close=")">
                #{id}
            </foreach>
        </if>
    </select>
    <select id="selectByCollegeIdAndStatus" resultMap="ProjectGroupResultMap" resultType="com.swpu.uchain.openexperiment.domain.ProjectGroup">
        select project_group.id,
            project_group.serial_number,
               project_group.address,
               project_group.create_time,
               project_group.creator_id,
               project_group.end_time,
               project_group.experiment_condition,
               project_group.suggest_group_type,
               project_group.experiment_type,
               project_group.achievement_check,
               project_group.limit_college,
               project_group.limit_major,
               project_group.limit_grade,
               project_group.fit_people_num,
               project_group.total_hours,
               project_group.lab_name,
               project_group.project_name,
               project_group.project_type,
               project_group.start_time,
               project_group.`status`,
               project_group.update_time,
               project_group.main_Content
        from openexperiment.project_group where status = #{projectStatus} and project_group.project_type = 1
        <if test="college!=null">
            and project_group.subordinate_college = #{college}
        </if>
    </select>

    <select id="getProjectGroupDetailVOByProjectId" resultMap="ProjectGroupDetailVOResultMap">
        select project_group.id,
               project_group.serial_number,
               project_group.address,
               project_group.create_time,
               project_group.creator_id,
               project_group.experiment_condition,
               project_group.suggest_group_type,
               project_group.experiment_type,
               project_group.achievement_check,
               project_group.limit_college,
               project_group.limit_major,
               project_group.limit_grade,
               project_group.fit_people_num,
               project_group.total_hours,
               project_group.lab_name,
               project_group.project_name,
               project_group.project_type,
               project_group.start_time,
               project_group.end_time,
               project_group.status,
               project_group.update_time,
               project_group.main_Content,
               project_group.apply_funds,
               project_group.is_open_topic,
               project_group.subordinate_college,
               key_project_status.status as key_project_status,
               key_project_status.project_id as whether_commit_key_apply,
               user_project_group.user_id        as u_code,
               user_project_group.technical_role as u_technical_role,
               user_project_group.work_division  as u_work_division,
               user_project_group.member_role    as u_member_role,
               user_project_group.personal_judge as u_personal_judge,
               user_project_group.join_time      as u_join_time,
               u_stu.user_type                    as u_user_type,
               u_stu.real_name                    as u_real_name,
               u_stu.sex                          as u_sex,
               u_stu.qq_num                       as u_qq_num,
               u_stu.fix_phone                    as u_fix_phone,
               u_stu.mobile_phone                 as u_mobile_phone,
               u_stu.institute                    as u_institute,
               u_stu.grade                        as u_grade,
               u_stu.major                        as u_major,
               u_stu.email                        as u_email
        from openexperiment.project_group
                 inner join openexperiment.user_project_group on user_project_group.project_group_id = project_group.id
                                                                     and user_project_group.status = 2 <!--2表示加入-->
                 inner join openexperiment.u_stu on user_project_group.user_id = u_stu.code
                 left join openexperiment.key_project_status on key_project_status.project_id = project_group_id
        where project_group.id = #{projectId}
    </select>
    <select id="getProjectTableInfoListByCollegeAndList" resultMap="ProjectTableInfoResultMap"
            resultType="com.swpu.uchain.openexperiment.VO.project.ProjectTableInfo">
        select distinct
            project_group.id,
            case
                when project_group.status = -3 then '立项失败'
                when project_group.status = -2 then '驳回修改'
                when project_group.status = -1 then '待指导老师确认'
                when project_group.status = 0 then '待实验室审核'
                when project_group.status = 1 then '实验室审核通过(待上报)'
                when project_group.status = 2 then '实验室上报(待二级单位审核)'
                when project_group.status = 3 then '二级单位审核通过(待上报)'
                when project_group.status = 4 then '二级单位上报(待职能部门审核)'
                when project_group.status = 5 then '职能部门审核通过(待中期检查)'
                when project_group.status = 6 then '中期检查(待结题审核)'
                when project_group.status = 7 then '结题' end as projectStatus,
            project_group.serial_number,
            project_group.temp_serial_number,
            project_group.address,
            project_group.create_time,
            project_group.start_time,
            project_group.end_time,
            project_group.total_hours,
            project_group.project_name,
            project_group.lab_name,
            project_group.apply_funds,
            project_group.project_type,
            project_group.experiment_type,
            project_group.suggest_group_type,
            project_group.subordinate_college  AS college,
            case
                when key_project_status.status = -3 then '立项失败'
                when key_project_status.status = -2 then '驳回修改'
                when key_project_status.status = -1 then '待指导老师确认'
                when key_project_status.status = 0 then '待实验室审核'
                when key_project_status.status = 1 then '实验室审核通过(待上报)'
                when key_project_status.status = 2 then '实验室上报(待二级单位审核)'
                when key_project_status.status = 3 then '二级单位审核通过(待上报)'
                when key_project_status.status = 4 then '二级单位上报(待职能部门审核)'
                when key_project_status.status = 5 then '职能部门审核通过(待中期检查)'
                when key_project_status.status = 6 then '中期检查(待结题审核)'
                when key_project_status.status = 7 then '结题' end as keyProjectStatus
        from openexperiment.project_group
        left join openexperiment.key_project_status on project_group.id = key_project_status.project_id
        <where>
            <if test="college!=null">
                project_group.subordinate_college = #{college}
            </if>
            <if test="status!=null">
                and project_group.status = #{status} or key_project_status.status =  #{status}
            </if>

        </where>
    </select>
    <select id="selectSpecifiedProjectList" resultType="java.lang.Integer">
        select count(id) from  openexperiment.project_group where id in
        <foreach collection="list" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
        and `status` = #{status}
    </select>
    <select id="conditionQuery" resultType="java.lang.Long">
        select project_group.id
            from openexperiment.project_group
        <if test="creator!=null">
            inner join openexperiment.u_stu on u_stu.code = project_group.creator_id and locate(#{creator},u_stu.real_name)
        </if>
        <where>
            project_group.project_type = 1
            <if test="status!=null">
                and project_group.status = #{status}
            </if>
            <if test="projectType!=null">
                and project_group.project_type= #{projectType}
            </if>
            <if test="subordinateCollege!=null">
                and subordinate_college = #{subordinateCollege}
            </if>
            <if test="suggestGroupType!=null">
                and project_group.suggest_group_type = #{suggestGroupType}
            </if>
            <if test="experimentType!=null">
                and project_group.experiment_type = #{experimentType}
            </if>
            <if test="startTime!=null" >
                and project_group.start_time &gt;= #{startTime}
            </if>
            <if test="endTime!=null">
                and project_group.end_time &lt;= #{endTime}
            </if>
            <!--locate函数会比like的全局匹配更快-->
            <if test="limitMajor!=null">
                and locate(#{limitMajor},project_group.limit_major) or limit_major is null
            </if>
            <if test="limitCollege!=null">
                and locate(#{limitCollege},project_group.limit_college) or limit_college is null
            </if>
            <if test="limitGrade!=null">
                and locate(#{limitGrade},project_group.limit_grade) or limit_grade is null
            </if>
            <if test="projectName!=null">
                and locate(#{projectName},project_group.project_name)
            </if>

        </where>
    </select>
    <select id="selectHistoricalInfoByUnitCollegeAndOperation" resultMap="ProjectGroupResultMap"
            resultType="com.swpu.uchain.openexperiment.domain.ProjectGroup">
        SELECT
            distinct
            project_group.id,
            project_group.serial_number,
            project_group.address,
            project_group.create_time,
            project_group.creator_id,
            project_group.end_time,
            project_group.is_open_topic,
            project_group.experiment_condition,
            project_group.suggest_group_type,
            project_group.experiment_type,
            project_group.achievement_check,
            project_group.limit_college,
            project_group.limit_major,
            project_group.limit_grade,
            project_group.fit_people_num,
            project_group.total_hours,
            project_group.lab_name,
            project_group.project_name,
            project_group.project_type,
            project_group.start_time,
            project_group.`status`,
            project_group.main_Content
        FROM openexperiment.project_group
        INNER JOIN openexperiment.operation_record ON operation_record.related_id = project_group.id
        WHERE operation_record.operation_unit = #{unit} AND operation_record.operation_type = #{type} AND operation_record.status = 'Y'
        <if test="college!=null">
            and operation_college = #{college}
        </if>
        <if test="projectType!=null">
            and project_type = #{projectType}
        </if>
            and project_group.`status` != -3 or project_group.`status` != -2

    </select>
    <select id="getMaxSerialNumberByCollege" resultType="java.lang.String">
        select  max(serial_number) from openexperiment.project_group where subordinate_college = #{college}
    </select>
    <select id="selectConclusionDTOs" resultType="com.swpu.uchain.openexperiment.DTO.ConclusionDTO">
        SELECT
            project_group.subordinate_college AS college,
            project_group.lab_name AS labName,
            project_group.serial_number AS id,
            project_group.experiment_type AS experimentType,
            project_group.total_hours AS totalHours,
            project_group.creator_id AS guideTeacherId,
            CONCAT(DATE_FORMAT(project_group.start_time,'%Y.%m.%d'),'-',DATE_FORMAT(project_group.end_time,'%Y.%m.%d')) AS startTimeAndEndTime,
            `user_project_group`.member_role AS userRole,
            `user`.real_name AS userName,
            `user`.`code` AS userId,
            CONCAT(`user`.class_num ,'-',`user`.grade) AS majorAndGrade
        FROM
            openexperiment.project_group
                INNER JOIN openexperiment.user_project_group ON project_group.id = user_project_group.project_group_id
                INNER JOIN openexperiment.`user` on user_project_group.user_id = `user`.`code`;
    </select>

    <select id="selectAllByList" resultType="com.swpu.uchain.openexperiment.domain.ProjectGroup">
        select project_group.id as id,
            project_group.serial_number as serialNumber,
            project_group.address as address,
            project_group.create_time as createTime,
            project_group.creator_id creatorId,
            project_group.end_time as endTime,
            project_group.experiment_condition experimentCondition,
            project_group.suggest_group_type as suggestGroupType,
            project_group.experiment_type experimentType,
            project_group.achievement_check as achievementCheck,
            project_group.limit_college as limitCollege,
            project_group.limit_major as limitMajor,
            project_group.limit_grade as limitGrade,
            project_group.fit_people_num as fitPeopleNum,
            project_group.total_hours as totalHours,
            project_group.lab_name labName,
            project_group.project_name as projectName,
            project_group.project_type projectType,
            project_group.start_time as startTime,
            project_group.`status`,
            project_group.main_Content mainContent
        from openexperiment.project_group
        where id in
        <foreach collection="list" item="id" close=")" separator="," open="(">
            #{id}
        </foreach>
    </select>
    <select id="conditionQueryOfKeyProject" resultType="java.lang.Long">
        select project_group.id
        from openexperiment.project_group inner join openexperiment.key_project_status
            on project_group.id = key_project_status.project_id
        <where>
            <if test="status!=null">
                project_group.status = #{status}
            </if>
            <if test="projectType!=null">
                and project_group.project_type= #{projectType}
            </if>
            <if test="applyFunds!=null">
                and project_group.apply_funds = #{applyFunds}
            </if>
            <if test="subordinateCollege!=null">
                and project_group.subordinate_college = #{subordinateCollege}
            </if>
            <if test="suggestGroupType!=null">
                and project_group.suggest_group_type = #{suggestGroupType}
            </if>
            <if test="experimentType!=null">
                and project_group.experiment_type = #{experimentType}
            </if>
            <if test="startTime!=null" >
                and project_group.start_time &gt;= #{startTime}
            </if>
            <if test="endTime!=null">
                and project_group.end_time &lt;= #{endTime}
            </if>
            <!--locate函数会比like的全局匹配更快-->
            <if test="limitMajor!=null">
                and locate(#{limitMajor},project_group.limit_major)
            </if>
            <if test="limitCollege!=null">
                and locate(#{limitCollege},project_group.limit_college)
            </if>
            <if test="limitGrade!=null">
                and locate(#{limitGrade},project_group.limit_grade)
            </if>
            <if test="projectName!=null">
                and locate(#{projectName},project_group.project_name)
            </if>
        </where>
    </select>
    <update id="updateProjectStatus">
        update openexperiment.project_group set `status` = #{status} where id =
            #{id}
    </update>

    <update id="updateProjectSerialNumber">
        update openexperiment.project_group set `serial_number` = #{serialNumber} where id =
        #{id}
    </update>
    <update id="updateProjectTempSerialNumber">
        update openexperiment.project_group set `temp_serial_number` = #{tempSerialNumber} where id = #{id}
    </update>
    <update id="updateProjectType">
        update openexperiment.project_group set project_type = #{type} where id = #{id}
    </update>
    <select id="selectKeyHistoricalInfoByUnitAndOperation" resultMap="ProjectGroupResultMap">
        SELECT
        distinct
        key_project_status.project_id as id,
        project_group.serial_number,
        project_group.address,
        project_group.create_time,
        project_group.creator_id,
        project_group.end_time,
        project_group.is_open_topic,
        project_group.experiment_condition,
        project_group.suggest_group_type,
        project_group.experiment_type,
        project_group.achievement_check,
        project_group.limit_college,
        project_group.limit_major,
        project_group.limit_grade,
        project_group.fit_people_num,
        project_group.total_hours,
        project_group.lab_name,
        project_group.project_name,
        project_group.project_type,
        project_group.start_time,
        key_project_status.`status`,
        project_group.main_Content
        FROM openexperiment.project_group
        INNER JOIN openexperiment.key_project_status on  project_group.id = key_project_status.project_id
        INNER JOIN openexperiment.operation_record ON operation_record.related_id = project_group.id
        WHERE operation_record.operation_unit = #{unit} AND operation_record.operation_type = #{type} AND operation_record.status = 'Y'
        <if test="college!=null">
            and operation_college = #{college}
        </if>
        <if test="establishFailed!=null">
            and key_project_status.status!= -3
        </if>
    </select>
    <select id="getCountOfSpecifiedStatusAndProjectProject" resultType="java.lang.Integer">
        select count(id) from openexperiment.project_group where `status` = #{status} and  subordinate_college = #{college}
    </select>
    <select id="getMaxTempSerialNumberByCollege" resultType="java.lang.String">
        select  max(temp_serial_number) from openexperiment.project_group where subordinate_college = #{college}
    </select>
    <select id="selectGeneralPassedProjectList" resultType="com.swpu.uchain.openexperiment.domain.ProjectGroup"
            resultMap="ProjectGroupResultMap">
        SELECT
        project_group.id,
        project_group.serial_number,
        project_group.address,
        project_group.create_time,
        project_group.creator_id,
        project_group.end_time,
        project_group.is_open_topic,
        project_group.experiment_condition,
        project_group.subordinate_college,
        project_group.suggest_group_type,
        project_group.experiment_type,
        project_group.achievement_check,
        project_group.limit_college,
        project_group.limit_major,
        project_group.limit_grade,
        project_group.fit_people_num,
        project_group.total_hours,
        project_group.lab_name,
        project_group.apply_funds,
        project_group.project_name,
        project_group.project_type,
        project_group.start_time,
        project_group.`status`,
        project_group.main_Content
        FROM openexperiment.project_group
        where
        project_group.project_type = 1
        <if test="college!=null">
                and project_group.subordinate_college = #{college}
            </if>
            <if  test="status!=null">
                and  project_group.`status` &gt;= #{status} and project_group.`status` != -3
                and project_group.`status` != -2
            </if>

    </select>
    <select id="selectKeyPassedProjectList" resultType="com.swpu.uchain.openexperiment.domain.ProjectGroup"
            resultMap="ProjectGroupResultMap">
        SELECT
        project_group.id,
        project_group.serial_number,
        project_group.address,
        project_group.create_time,
        project_group.creator_id,
        project_group.end_time,
        project_group.is_open_topic,
        project_group.experiment_condition,
        project_group.suggest_group_type,
        project_group.experiment_type,
        project_group.achievement_check,
        project_group.subordinate_college,
        project_group.limit_college,
        project_group.limit_major,
        project_group.limit_grade,
        project_group.fit_people_num,
        project_group.total_hours,
        project_group.lab_name,
        project_group.project_name,
        project_group.project_type,
        project_group.start_time,
        project_group.apply_funds,
        key_project_status.`status`,
        project_group.main_Content
        FROM openexperiment.project_group
        inner join openexperiment.key_project_status on project_group.id = key_project_status.project_id
        and project_group.project_type = 2
        <where>
            <if test="college!=null">
                and project_group.subordinate_college = #{college}
            </if>
            <if  test="status!=null">
                and  key_project_status.`status` &gt;= #{status}
                  and key_project_status.`status` != -3
            </if>
        </where>
    </select>
    <select id="selectGeneralRejectedProjectList"
            resultType="com.swpu.uchain.openexperiment.domain.ProjectGroup" resultMap="ProjectGroupResultMap">
        SELECT
        project_group.id,
        project_group.serial_number,
        project_group.address,
        project_group.create_time,
        project_group.creator_id,
        project_group.end_time,
        project_group.is_open_topic,
        project_group.experiment_condition,
        project_group.suggest_group_type,
        project_group.experiment_type,
        project_group.achievement_check,
        project_group.subordinate_college,
        project_group.limit_college,
        project_group.limit_major,
        project_group.limit_grade,
        project_group.fit_people_num,
        project_group.total_hours,
        project_group.lab_name,
        project_group.project_name,
        project_group.project_type,
        project_group.start_time,
        project_group.apply_funds,
        project_group.`status`,
        project_group.main_Content
        FROM openexperiment.project_group
        <where>
            project_group.`status` = -3
            or project_group.`status` = -2
            and project_group.project_type = 1
            <if test="college!=null">
                and project_group.subordinate_college = #{college}
            </if>
        </where>
    </select>

    <select id="selectKeyRejectedProjectList"
            resultType="com.swpu.uchain.openexperiment.domain.ProjectGroup" resultMap="ProjectGroupResultMap">
        SELECT
        project_group.id,
        project_group.serial_number,
        project_group.address,
        project_group.create_time,
        project_group.creator_id,
        project_group.end_time,
        project_group.is_open_topic,
        project_group.experiment_condition,
        project_group.suggest_group_type,
        project_group.experiment_type,
        project_group.achievement_check,
        project_group.subordinate_college,
        project_group.limit_college,
        project_group.limit_major,
        project_group.limit_grade,
        project_group.fit_people_num,
        project_group.total_hours,
        project_group.lab_name,
        project_group.project_name,
        project_group.project_type,
        project_group.start_time,
        project_group.apply_funds,
        key_project_status.`status`,
        project_group.main_Content
        FROM openexperiment.project_group
        inner join openexperiment.key_project_status on project_group.id = key_project_status.project_id
                                                            and project_group.project_type = 2
        <where>
            <if test="college!=null">
                and project_group.subordinate_college = #{college}
            </if>
            and key_project_status.`status` = -3 or key_project_status.`status` = -2
        </where>
    </select>
</mapper>